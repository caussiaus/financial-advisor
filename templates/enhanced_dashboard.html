<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView-Style Mesh Dashboard</title>
    
    <!-- D3.js for advanced charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        :root {
            --tradingview-bg: #131722;
            --tradingview-panel: #1e222d;
            --tradingview-border: #2a2e39;
            --tradingview-text: #d1d4dc;
            --tradingview-accent: #2962ff;
            --tradingview-success: #089981;
            --tradingview-danger: #f23645;
            --tradingview-warning: #ff9800;
        }
        
        body {
            background-color: var(--tradingview-bg);
            color: var(--tradingview-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .tradingview-header {
            background: var(--tradingview-panel);
            border-bottom: 1px solid var(--tradingview-border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tradingview-logo {
            font-size: 18px;
            font-weight: bold;
            color: var(--tradingview-accent);
        }

        .tradingview-controls {
            display: flex;
            gap: 10px;
        }

        .tradingview-btn {
            background: var(--tradingview-panel);
            border: 1px solid var(--tradingview-border);
            color: var(--tradingview-text);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tradingview-btn:hover {
            background: var(--tradingview-accent);
            color: white;
        }

        .tradingview-btn.active {
            background: var(--tradingview-accent);
            color: white;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 300px;
            background: var(--tradingview-panel);
            border-right: 1px solid var(--tradingview-border);
            padding: 20px;
            overflow-y: auto;
        }

        .chart-area {
            flex: 1;
            position: relative;
            background: var(--tradingview-bg);
        }

        .chart-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .analysis-window {
            position: absolute;
            top: 0;
            height: 100%;
            width: 8px;
            background: linear-gradient(to bottom, #ffd700, #ffed4e, #ffd700);
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            z-index: 15;
            left: 70%;
        }

        .now-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(to bottom, #00ff00, #32cd32, #00ff00);
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            z-index: 15;
            left: 60%;
        }

        .chart-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 34, 45, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--tradingview-border);
            z-index: 20;
        }

        .metrics-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(30, 34, 45, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--tradingview-border);
            z-index: 20;
            min-width: 200px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .metric-label {
            color: var(--tradingview-text);
            opacity: 0.8;
        }

        .metric-value {
            font-weight: bold;
            color: var(--tradingview-accent);
        }

        .metric-value.positive {
            color: var(--tradingview-success);
        }

        .metric-value.negative {
            color: var(--tradingview-danger);
        }

        .time-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 34, 45, 0.9);
            color: var(--tradingview-text);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            border: 1px solid var(--tradingview-border);
            z-index: 20;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--tradingview-accent);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--tradingview-border);
            padding-bottom: 5px;
        }

        .client-card {
            background: var(--tradingview-panel);
            border: 1px solid var(--tradingview-border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .client-card:hover {
            border-color: var(--tradingview-accent);
            background: rgba(41, 98, 255, 0.1);
        }

        .client-card.selected {
            border-color: var(--tradingview-accent);
            background: rgba(41, 98, 255, 0.2);
        }

        .client-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .client-details {
            font-size: 11px;
            opacity: 0.8;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-healthy { background-color: var(--tradingview-success); }
        .status-degraded { background-color: var(--tradingview-warning); }
        .status-unhealthy { background-color: var(--tradingview-danger); }

        .zoom-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .zoom-btn {
            background: var(--tradingview-panel);
            border: 1px solid var(--tradingview-border);
            color: var(--tradingview-text);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--tradingview-accent);
            color: white;
        }

        .alert-custom {
            background: var(--tradingview-panel);
            border: 1px solid var(--tradingview-border);
            color: var(--tradingview-text);
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .modal-content {
            background: var(--tradingview-panel);
            border: 1px solid var(--tradingview-border);
            color: var(--tradingview-text);
        }

        .modal-header {
            background: var(--tradingview-panel);
            border-bottom: 1px solid var(--tradingview-border);
            color: var(--tradingview-text);
        }

        .form-control {
            background: var(--tradingview-bg);
            border: 1px solid var(--tradingview-border);
            color: var(--tradingview-text);
        }

        .form-control:focus {
            background: var(--tradingview-bg);
            border-color: var(--tradingview-accent);
            color: var(--tradingview-text);
            box-shadow: 0 0 0 0.2rem rgba(41, 98, 255, 0.25);
        }

        .btn-primary {
            background: var(--tradingview-accent);
            border-color: var(--tradingview-accent);
        }

        .btn-primary:hover {
            background: #1e4bd8;
            border-color: #1e4bd8;
        }
    </style>
</head>
<body>
    <!-- TradingView-Style Header -->
    <div class="tradingview-header">
        <div class="tradingview-logo">
            <i class="fas fa-chart-line me-2"></i>
            Mesh Portfolio Analysis
        </div>
        <div class="tradingview-controls">
            <span class="status-indicator status-healthy" id="system-status"></span>
            <span id="status-text">System Healthy</span>
            <button class="tradingview-btn" onclick="showSystemControls()">
                <i class="fas fa-cog"></i> Controls
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-users me-2"></i>Clients
                </div>
                <div id="client-list">
                    <div class="text-center text-muted">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p>Loading clients...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-chart-bar me-2"></i>System Health
                </div>
                <div id="health-status">
                    <div class="alert alert-success alert-custom">
                        <strong>Status:</strong> Healthy<br>
                        <strong>Components:</strong> All operational
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-lightbulb me-2"></i>Recommendations
                </div>
                <div id="recommendations-box">
                    <div class="text-muted">Select a client to view recommendations</div>
                </div>
            </div>
        </div>

        <!-- Main Chart Area -->
        <div class="chart-area">
            <div class="chart-container">
                <svg id="portfolio-chart" width="100%" height="100%"></svg>
            </div>
            
            <div class="chart-overlay">
                <div class="now-marker" id="now-marker"></div>
                <div class="analysis-window" id="analysis-window"></div>
            </div>

            <!-- Chart Controls -->
            <div class="chart-controls">
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="adjustZoom(1.2)">Zoom In</button>
                    <button class="zoom-btn" onclick="adjustZoom(0.8)">Zoom Out</button>
                    <button class="zoom-btn" onclick="resetZoom()">Reset</button>
                </div>
                <div style="font-size: 11px; color: var(--tradingview-text); opacity: 0.8;">
                    Fixed Analysis Window
                </div>
            </div>

            <!-- Metrics Panel -->
            <div class="metrics-panel">
                <div class="sidebar-title">Portfolio Metrics</div>
                <div class="metric-item">
                    <span class="metric-label">Our Avg:</span>
                    <span class="metric-value" id="our-avg">$0</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Competition Avg:</span>
                    <span class="metric-value" id="competition-avg">$0</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Outperformance:</span>
                    <span class="metric-value positive" id="outperformance">+0%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Volatility:</span>
                    <span class="metric-value" id="volatility">0%</span>
                </div>
            </div>

            <!-- Time Indicator -->
            <div class="time-indicator" id="time-indicator">
                Portfolio Analysis Active
            </div>
        </div>
    </div>

    <!-- System Controls Modal -->
    <div class="modal fade" id="systemControlsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">System Controls</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>System Health</h6>
                            <div id="modal-health-status"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Performance Metrics</h6>
                            <div id="modal-performance-metrics"></div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>System Actions</h6>
                            <button class="tradingview-btn" onclick="restartComponents()">
                                <i class="fas fa-redo"></i> Restart Components
                            </button>
                            <button class="tradingview-btn" onclick="clearCache()">
                                <i class="fas fa-broom"></i> Clear Cache
                            </button>
                            <button class="tradingview-btn" onclick="exportData()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <button class="tradingview-btn" onclick="importData()">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedClient = null;
        let currentZoom = 1;
        let chartOffset = 0;
        let allPaths = [];
        let xScale, yScale, line;
        let chart, svg;
        let animationId = null;

        // Configuration
        const config = {
            width: window.innerWidth - 300, // Account for sidebar
            height: window.innerHeight - 60, // Account for header
            margin: { top: 40, right: 60, bottom: 60, left: 60 }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadSystemHealth();
            loadClients();
            startChartAnimation();
        });

        // Initialize TradingView-style chart
        function initChart() {
            // Generate synthetic portfolio data
            const people = generatePeopleData();
            allPaths = generatePortfolioPaths(people);
            
            // Setup D3 chart
            setupChart();
            
            // Initial draw
            drawPortfolioLines();
        }

        // Generate synthetic people data
        function generatePeopleData() {
            const people = [];
            
            // Our clients (15 people)
            for (let i = 1; i <= 15; i++) {
                people.push({
                    id: `our_${i}`,
                    name: `Client ${i}`,
                    type: 'our',
                    initialValue: 50000 + Math.random() * 150000,
                    riskProfile: 0.3 + Math.random() * 0.4,
                    incomeLevel: 50000 + Math.random() * 100000
                });
            }
            
            // Competition clients (12 people)
            for (let i = 1; i <= 12; i++) {
                people.push({
                    id: `competition_${i}`,
                    name: `Competitor ${i}`,
                    type: 'competition',
                    initialValue: 40000 + Math.random() * 120000,
                    riskProfile: 0.2 + Math.random() * 0.3,
                    incomeLevel: 40000 + Math.random() * 80000
                });
            }
            
            return people;
        }

        // Generate portfolio paths
        function generatePortfolioPaths(people) {
            const startDate = new Date('2022-01-01');
            const endDate = new Date('2025-12-31');
            const days = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            const allPaths = [];
            
            people.forEach(person => {
                const path = [];
                let currentValue = person.initialValue;
                
                for (let i = 0; i <= days; i += 7) {
                    const date = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
                    
                    let volatility, drift;
                    if (person.type === 'our') {
                        volatility = 0.02 + person.riskProfile * 0.03;
                        drift = 0.0008 + person.riskProfile * 0.0004;
                    } else {
                        volatility = 0.015 + person.riskProfile * 0.02;
                        drift = 0.0005 + person.riskProfile * 0.0002;
                    }
                    
                    const randomReturn = Math.random();
                    const logReturn = Math.log(1 + drift) - 0.5 * volatility * volatility + 
                                    volatility * Math.sqrt(1/52) * (randomReturn - 0.5);
                    
                    currentValue *= Math.exp(logReturn);
                    
                    path.push({
                        date: date,
                        value: currentValue,
                        personId: person.id,
                        personName: person.name,
                        type: person.type,
                        quarter: `Q${Math.floor((date.getMonth() / 3) + 1)} ${date.getFullYear()}`
                    });
                }
                
                allPaths.push({
                    person: person,
                    path: path
                });
            });
            
            return allPaths;
        }

        // Setup D3 chart
        function setupChart() {
            svg = d3.select('#portfolio-chart')
                .attr('width', config.width)
                .attr('height', config.height);
            
            const chartWidth = config.width - config.margin.left - config.margin.right;
            const chartHeight = config.height - config.margin.top - config.margin.bottom;
            
            const allData = allPaths.flatMap(p => p.path);
            const allDates = allData.map(d => d.date);
            const allValues = allData.map(d => d.value);
            
            xScale = d3.scaleTime()
                .domain(d3.extent(allDates))
                .range([0, chartWidth]);
            
            yScale = d3.scaleLinear()
                .domain([0, d3.max(allValues)])
                .range([chartHeight, 0]);
            
            line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);
            
            chart = svg.append('g')
                .attr('transform', `translate(${config.margin.left}, ${config.margin.top})`);
            
            // Add grid
            chart.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(xScale).tickSize(-chartHeight).tickFormat(''));
            
            chart.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale).tickSize(-chartWidth).tickFormat(''));
            
            // Add axes
            chart.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(xScale));
            
            chart.append('g')
                .attr('class', 'y-axis')
                .call(d3.axisLeft(yScale));
        }

        // Draw portfolio lines
        function drawPortfolioLines() {
            chart.selectAll('.portfolio-line, .portfolio-outline').remove();
            
            const chartWidth = config.width - config.margin.left - config.margin.right;
            const chartHeight = config.height - config.margin.top - config.margin.bottom;
            
            const allData = allPaths.flatMap(p => p.path);
            const allDates = allData.map(d => d.date);
            const allValues = allData.map(d => d.value);
            
            const dateRange = d3.extent(allDates);
            const dateSpan = dateRange[1] - dateRange[0];
            const zoomedDateRange = [
                dateRange[0] + (dateSpan * chartOffset),
                dateRange[0] + (dateSpan * (chartOffset + 1/currentZoom))
            ];
            
            xScale.domain(zoomedDateRange);
            
            const visibleData = allPaths.map(portfolio => {
                const visiblePath = portfolio.path.filter(d => 
                    d.date >= zoomedDateRange[0] && d.date <= zoomedDateRange[1]
                );
                return visiblePath;
            }).flat();
            
            const visibleValues = visibleData.map(d => d.value);
            if (visibleValues.length > 0) {
                const valueRange = d3.extent(visibleValues);
                const valueSpan = valueRange[1] - valueRange[0];
                const zoomedValueSpan = valueSpan / currentZoom;
                const centerValue = (valueRange[0] + valueRange[1]) / 2;
                
                yScale.domain([
                    Math.max(0, centerValue - zoomedValueSpan / 2),
                    centerValue + zoomedValueSpan / 2
                ]);
            }
            
            line.x(d => xScale(d.date)).y(d => yScale(d.value));
            
            chart.select('.x-axis').call(d3.axisBottom(xScale));
            chart.select('.y-axis').call(d3.axisLeft(yScale));
            
            allPaths.forEach((portfolio, index) => {
                const isOurClient = portfolio.person.type === 'our';
                const strokeColor = isOurClient ? '#2962ff' : '#787b86';
                const outlineColor = isOurClient ? '#089981' : '#f23645';
                const strokeWidth = isOurClient ? 2 : 1.5;
                const opacity = isOurClient ? 0.8 : 0.6;
                
                const visiblePath = portfolio.path.filter(d => 
                    d.date >= zoomedDateRange[0] && d.date <= zoomedDateRange[1]
                );
                
                if (visiblePath.length > 0) {
                    chart.append('path')
                        .datum(visiblePath)
                        .attr('class', `portfolio-line ${portfolio.person.type}-line`)
                        .attr('d', line)
                        .style('fill', 'none')
                        .style('stroke', strokeColor)
                        .style('stroke-width', strokeWidth)
                        .style('opacity', opacity);
                    
                    chart.append('path')
                        .datum(visiblePath)
                        .attr('class', `portfolio-outline ${portfolio.person.type}-outline`)
                        .attr('d', line)
                        .style('fill', 'none')
                        .style('stroke', outlineColor)
                        .style('stroke-width', strokeWidth + 2)
                        .style('opacity', 0.3);
                }
            });
            
            updateMetrics();
        }

        // Update metrics
        function updateMetrics() {
            const currentOurValues = allPaths
                .filter(p => p.person.type === 'our')
                .map(p => {
                    const midIndex = Math.floor(p.path.length * 0.6);
                    return p.path[midIndex]?.value || 0;
                })
                .filter(v => v > 0);
            
            const currentCompetitionValues = allPaths
                .filter(p => p.person.type === 'competition')
                .map(p => {
                    const midIndex = Math.floor(p.path.length * 0.6);
                    return p.path[midIndex]?.value || 0;
                })
                .filter(v => v > 0);
            
            const ourAvg = currentOurValues.length > 0 ? 
                currentOurValues.reduce((a, b) => a + b, 0) / currentOurValues.length : 0;
            const competitionAvg = currentCompetitionValues.length > 0 ? 
                currentCompetitionValues.reduce((a, b) => a + b, 0) / currentCompetitionValues.length : 0;
            const outperformance = ourAvg > 0 ? ((ourAvg - competitionAvg) / competitionAvg * 100) : 0;
            
            document.getElementById('our-avg').textContent = `$${ourAvg.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
            document.getElementById('competition-avg').textContent = `$${competitionAvg.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
            document.getElementById('outperformance').textContent = `${outperformance > 0 ? '+' : ''}${outperformance.toFixed(1)}%`;
            document.getElementById('outperformance').className = `metric-value ${outperformance > 0 ? 'positive' : 'negative'}`;
        }

        // Start chart animation
        function startChartAnimation() {
            const maxOffset = 0.8;
            let direction = 1;
            
            function animate() {
                chartOffset += 0.002 * direction;
                
                if (chartOffset >= maxOffset) {
                    direction = -1;
                } else if (chartOffset <= 0) {
                    direction = 1;
                }
                
                drawPortfolioLines();
                
                const allData = allPaths.flatMap(p => p.path);
                const allDates = allData.map(d => d.date);
                const dateRange = d3.extent(allDates);
                const currentDate = new Date(dateRange[0].getTime() + 
                    (dateRange[1] - dateRange[0]) * (0.5 + chartOffset * 0.3));
                const currentQuarter = `Q${Math.floor((currentDate.getMonth() / 3) + 1)} ${currentDate.getFullYear()}`;
                
                document.getElementById('time-indicator').textContent = `Moving: ${currentQuarter}`;
                
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Zoom control functions
        function adjustZoom(factor) {
            currentZoom *= factor;
            currentZoom = Math.max(0.5, Math.min(3, currentZoom));
            drawPortfolioLines();
        }

        function resetZoom() {
            currentZoom = 1;
            chartOffset = 0;
            drawPortfolioLines();
        }

        // API functions
        async function loadSystemHealth() {
            try {
                const response = await axios.get('/api/health');
                const data = response.data;
                updateSystemStatus(data.status, data.components);
            } catch (error) {
                console.error('Error loading system health:', error);
            }
        }

        async function loadClients() {
            try {
                const response = await axios.get('/api/clients');
                const data = response.data;
                displayClients(data.clients);
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        function updateSystemStatus(status, components) {
            const statusElement = document.getElementById('system-status');
            const statusText = document.getElementById('status-text');
            
            statusElement.className = `status-indicator status-${status}`;
            statusText.textContent = `System ${status.charAt(0).toUpperCase() + status.slice(1)}`;
        }

        function displayClients(clients) {
            const clientList = document.getElementById('client-list');
            
            if (clients.length === 0) {
                clientList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-users fa-2x mb-2"></i><p>No clients added yet</p></div>';
                return;
            }
            
            let html = '';
            clients.forEach(client => {
                html += `
                    <div class="client-card" onclick="selectClient('${client.id}')">
                        <div class="client-name">${client.name}</div>
                        <div class="client-details">Age: ${client.age} | Income: $${client.income.toLocaleString()}</div>
                    </div>
                `;
            });
            
            clientList.innerHTML = html;
        }

        function selectClient(clientId) {
            selectedClient = clientId;
            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.client-card').classList.add('selected');
            loadRecommendations(clientId);
        }

        async function loadRecommendations(clientId) {
            try {
                const response = await axios.get(`/api/recommendations/${clientId}`);
                const data = response.data;
                displayRecommendations(data.recommendations);
            } catch (error) {
                console.error('Error loading recommendations:', error);
            }
        }

        function displayRecommendations(recommendations) {
            const recommendationsBox = document.getElementById('recommendations-box');
            
            let html = '';
            for (const [category, items] of Object.entries(recommendations)) {
                html += `
                    <div style="margin-bottom: 10px;">
                        <div style="font-size: 12px; color: var(--tradingview-accent); margin-bottom: 5px;">
                            ${category.replace('_', ' ').toUpperCase()}
                        </div>
                        <ul style="font-size: 11px; margin: 0; padding-left: 15px;">
                `;
                
                items.forEach(item => {
                    html += `<li style="margin-bottom: 2px;">${item}</li>`;
                });
                
                html += '</ul></div>';
            }
            
            recommendationsBox.innerHTML = html;
        }

        function showSystemControls() {
            const modal = new bootstrap.Modal(document.getElementById('systemControlsModal'));
            modal.show();
        }

        async function restartComponents() {
            try {
                await axios.post('/api/system/control', { action: 'restart_components' });
                alert('Components restarted successfully!');
                loadSystemHealth();
            } catch (error) {
                alert('Error restarting components: ' + error.response?.data?.error || error.message);
            }
        }

        async function clearCache() {
            try {
                await axios.post('/api/system/control', { action: 'clear_cache' });
                alert('Cache cleared successfully!');
            } catch (error) {
                alert('Error clearing cache: ' + error.response?.data?.error || error.message);
            }
        }

        async function exportData() {
            try {
                const response = await axios.post('/api/system/control', { action: 'export_data' });
                const data = response.data;
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mesh_dashboard_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch (error) {
                alert('Error exporting data: ' + error.response?.data?.error || error.message);
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        await axios.post('/api/system/control', { 
                            action: 'import_data',
                            data: data
                        });
                        
                        alert('Data imported successfully!');
                        loadClients();
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                }
            };
            input.click();
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            config.width = window.innerWidth - 300;
            config.height = window.innerHeight - 60;
            
            svg.attr('width', config.width).attr('height', config.height);
            setupChart();
            drawPortfolioLines();
        });
    </script>
</body>
</html> 